-- checking repeats 
SELECT cst_id, count(*)
FROM (SELECT ci.[cst_id]
      ,ci.[cst_key]
      ,ci.[cst_firstname]
      ,ci.[cst_lastname]
      ,ci.[cst_marital_status]
      ,ci.[cst_gndr]
      ,ci.[cst_create_date]
      ,ci.[dwh_create_date]
	  ,ca.[bdate]
      ,ca.[gen]
	  ,la.[cntry]
  FROM [Datawarehouse].[Silver].[crm_cust_info] ci

  LEFT JOIN [Datawarehouse].[Silver].[erp_cust_az12] ca
  ON   ci.[cst_key] = ca.cid


  left join [Datawarehouse].[Silver].[erp_loc_a101] la
  ON   ci.[cst_key] = la.cid) t
  group by cst_id Having count (*) > 1

  -- checking integration of genders 
  SELECT DISTINCT
      ci.[cst_gndr]
      ,ca.[gen]
  FROM [Datawarehouse].[Silver].[crm_cust_info] ci

  LEFT JOIN [Datawarehouse].[Silver].[erp_cust_az12] ca
  ON   ci.[cst_key] = ca.cid



  left join [Datawarehouse].[Silver].[erp_loc_a101] la
  ON   ci.[cst_key] = la.cid

  ORDER BY 1,2


--creating the view
CREATE VIEW Gold.dim_customers AS
SELECT 
       ROW_NUMBER() OVER (ORDER BY cst_id) AS customer_key
       ,ci.[cst_id] as customer_id
      ,ci.[cst_key] as customer_number
      ,ci.[cst_firstname] as first_name
      ,ci.[cst_lastname] as last_name
	  ,la.[cntry] as country
      ,ci.[cst_marital_status] as marital_status
        ,CASE WHEN ci.[cst_gndr] != 'n/a' then ci.[cst_gndr]
	  ELSE COALESCE(ca.gen, 'n/a')
	  END AS gender
	  ,ca.[bdate] as birthday
      ,ci.[cst_create_date] as create_date


  FROM [Datawarehouse].[Silver].[crm_cust_info] ci

  LEFT JOIN [Datawarehouse].[Silver].[erp_cust_az12] ca
  ON   ci.[cst_key] = ca.cid


  left join [Datawarehouse].[Silver].[erp_loc_a101] la
  ON   ci.[cst_key] = la.cid
